name: "Agent: Deploy Karpathy (Auto-PR Mode)"

on:
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'Commit message'
        required: true
        default: 'chore: enforce Karpathy persona (Global)'

jobs:
  deploy-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Central Command
        uses: actions/checkout@v4

      - name: ü§ñ Run Intelligent Agent
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          MASTER_PATH: ".github/copilot-instructions.md"
        run: |
          # [CRITICAL] ÏóêÎü¨Í∞Ä ÎÇòÎèÑ Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä Î©àÏ∂îÏßÄ ÏïäÎèÑÎ°ù ÏÑ§Ï†ï
          set +e
          
          echo "üîç [Check] Verifying Master Persona..."
          # ÌååÏùºÏù¥ Ïã§Ï†ú Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌïúÎ≤à Îçî Ï≤¥ÌÅ¨
          if [ ! -f "$MASTER_PATH" ]; then
            echo "‚ùå FATAL: Script cannot find '$MASTER_PATH' inside the runner."
            echo "   Please double check if the file exists in the 'main' branch."
            exit 1
          fi
          
          CONTENT=$(cat $MASTER_PATH)
          echo "‚úÖ Master Persona Loaded. Ready to Deploy."

          echo "üöÄ [Start] Global Deployment Loop..."
          
          # Î™®Îì† Î†àÌè¨ÏßÄÌÜ†Î¶¨ ÏàúÌöå (ÏµúÎåÄ 1000Í∞ú)
          gh repo list --source --limit 1000 --json name,defaultBranchRef --jq '.[] | "\(.name) \(.defaultBranchRef.name)"' | while read -r repo branch; do
            echo "---------------------------------------------------"
            echo "üéØ Target: $repo (Branch: $branch)"
            
            # 1. Í∏∞Ï°¥ ÌååÏùº ÌôïÏù∏
            EXISTING=$(gh api "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/contents/.github/copilot-instructions.md" --jq .content 2>/dev/null | base64 -d 2>/dev/null)
            
            if [ -z "$EXISTING" ]; then
              FINAL_CONTENT="$CONTENT"
              MODE="Create"
            elif echo "$EXISTING" | grep -q "KARPATHY_CORE_GLOBAL"; then
              echo "   ‚úÖ Already up to date. Skipping."
              continue
            else
              FINAL_CONTENT="$CONTENT"$'\n\n'"$EXISTING"
              MODE="Update"
            fi
            
            B64_CONTENT=$(echo "$FINAL_CONTENT" | base64 -w 0)

            # 2. [ÏãúÎèÑ A] ÏßÅÏ†ë Ìë∏Ïãú (Direct Push)
            echo "   Trying Direct Push..."
            OUTPUT=$(gh api --method PUT "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/contents/.github/copilot-instructions.md" \
              -f message="${{ inputs.commit_message }}" \
              -f content="$B64_CONTENT" \
              -f branch="$branch" 2>&1)
            
            if [ $? -eq 0 ]; then
              echo "   ‚úÖ Success: Direct Push completed."
              continue
            fi

            # 3. [ÏãúÎèÑ B] Ïã§Ìå® Ïãú PR ÏÉùÏÑ± (Auto-PR)
            echo "   ‚ö†Ô∏è Direct Push Failed (Protected?). Switching to Auto-PR mode..."
            
            PR_BRANCH="chore/update-karpathy-persona-$(date +%s)"
            SHA_BASE=$(gh api "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/git/ref/heads/$branch" --jq .object.sha)
            
            # Î∏åÎûúÏπò ÏÉùÏÑ± -> ÌååÏùº Ìë∏Ïãú -> PR ÏÉùÏÑ±
            gh api --method POST "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/git/refs" -f ref="refs/heads/$PR_BRANCH" -f sha="$SHA_BASE" --silent
            
            # ÌååÏùº Ìë∏Ïãú (ÎçÆÏñ¥Ïì∞Í∏∞ ÏúÑÌï¥ SHA ÌôïÏù∏)
            FILE_SHA=$(gh api "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/contents/.github/copilot-instructions.md" --jq .sha 2>/dev/null)
            
            if [ -n "$FILE_SHA" ]; then
               gh api --method PUT "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/contents/.github/copilot-instructions.md" -f message="${{ inputs.commit_message }}" -f content="$B64_CONTENT" -f branch="$PR_BRANCH" -f sha="$FILE_SHA" --silent
            else
               gh api --method PUT "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/contents/.github/copilot-instructions.md" -f message="${{ inputs.commit_message }}" -f content="$B64_CONTENT" -f branch="$PR_BRANCH" --silent
            fi
            
            gh api --method POST "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/pulls" -f title="ü§ñ AI: Enforce Karpathy Persona" -f body="Automated PR to inject global Karpathy guidelines." -f head="$PR_BRANCH" -f base="$branch" --silent
              
            if [ $? -eq 0 ]; then
              echo "   ‚úÖ Success: Pull Request Created."
            else
              echo "   ‚ùå FATAL: PR creation failed. Check logs."
            fi
          done
