name: "Agent: Deploy Karpathy Persona"

# 1. ë°œì£¼ì„œ(Trigger): ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ APIë¥¼ í˜¸ì¶œí•  ë•Œë§Œ ì‘ë™
on:
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'Commit message for the update'
        required: true
        default: 'chore: update global copilot instructions via Agent'

jobs:
  inject-persona:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout Dotfiles (Central Command)
        uses: actions/checkout@v4

      - name: ğŸ¤– Run Injection Agent
        env:
          # GitHubì˜ íŠ¹ìˆ˜ ê¶Œí•œ í† í° ì‚¬ìš© (ìì‹ ì˜ ëª¨ë“  ë ˆí¬ ì ‘ê·¼ìš©)
          GH_TOKEN: ${{ secrets.GH_PAT }} 
        run: |
          # 1. ë§ˆìŠ¤í„° í˜ë¥´ì†Œë‚˜ ë¡œë“œ
          MASTER_FILE=".github/copilot-instructions.md"
          
          if [ ! -f "$MASTER_FILE" ]; then
            echo "âŒ Error: Master instructions not found in dotfiles!"
            exit 1
          fi
          
          CONTENT=$(cat $MASTER_FILE)
          echo "âœ… Master Persona Loaded. Target: All Repositories"

          # 2. ì‚¬ìš©ì(graviton94)ì˜ ëª¨ë“  ë¦¬í¬ì§€í† ë¦¬ ì¡°íšŒ (ìµœëŒ€ 1000ê°œ)
          # (Forkëœ ë ˆí¬ ì œì™¸, ì†ŒìŠ¤ ë ˆí¬ë§Œ ëŒ€ìƒ)
          gh repo list --source --limit 1000 --json name --jq '.[].name' | while read -r repo; do
            echo "---------------------------------------------------"
            echo "ğŸ¯ Targeting: $repo"
            
            # 3. ê° ë ˆí¬ì§€í† ë¦¬ì˜ ê¸°ì¡´ íŒŒì¼ ê²€ì‚¬ (API ì‚¬ìš©)
            EXISTING=$(gh api "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/contents/.github/copilot-instructions.md" --jq .content 2>/dev/null | base64 -d 2>/dev/null)
            
            # 4. ìŠ¤ë§ˆíŠ¸ ë³‘í•© ë¡œì§ (ì¶©ëŒ ë°©ì§€)
            if [ -z "$EXISTING" ]; then
              echo "   -> Status: New File. Injecting..."
              FINAL_CONTENT="$CONTENT"
            elif echo "$EXISTING" | grep -q "KARPATHY_CORE_GLOBAL"; then
              echo "   -> Status: Already Updated. Skipping."
              continue
            else
              echo "   -> Status: Merging with existing rules."
              FINAL_CONTENT="$CONTENT"$'\n\n'"$EXISTING"
            fi

            # 5. GitHub APIë¡œ íŒŒì¼ ì§ì ‘ ì»¤ë°‹ (ë¡œì»¬ í´ë¡  X, ì„œë²„ì—ì„œ ì¦‰ì‹œ ì²˜ë¦¬)
            gh api --method PUT "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/contents/.github/copilot-instructions.md" \
              -f message="${{ inputs.commit_message }}" \
              -f content="$(echo "$FINAL_CONTENT" | base64 -w 0)" \
              -f branch="main" \
              --silent
              
            if [ $? -eq 0 ]; then
              echo "   âœ… Success: Instructions deployed."
            else
              echo "   âš ï¸ Warning: Failed (Check branch protection or permissions)."
            fi
          done
