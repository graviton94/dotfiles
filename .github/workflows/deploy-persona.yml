name: "Agent: Deploy Karpathy Persona"

on:
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'Commit message for the update'
        required: true
        default: 'chore: update global copilot instructions via Agent'

jobs:
  inject-persona:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout Dotfiles
        uses: actions/checkout@v4

      - name: Run Injection Agent
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # [CRITICAL] Ïò§Î•òÍ∞Ä Î∞úÏÉùÌï¥ÎèÑ Î©àÏ∂îÏßÄ ÏïäÎèÑÎ°ù ÏÑ§Ï†ï
          set +e
          
          MASTER_FILE=".github/copilot-instructions.md"
          
          if [ ! -f "$MASTER_FILE" ]; then
            echo "‚ùå Error: Master instructions not found!"
            exit 1
          fi
          
          CONTENT=$(cat $MASTER_FILE)
          echo "‚úÖ Master Persona Loaded."

          # Î†àÌè¨ÏßÄÌÜ†Î¶¨ Î™©Î°ù ÏàúÌöå
          gh repo list --source --limit 1000 --json name --jq '.[].name' | while read -r repo; do
            echo "---------------------------------------------------"
            echo "üéØ Targeting: $repo"
            
            # 1. Í∏∞Ï°¥ ÌååÏùº ÌôïÏù∏ (Ïã§Ìå® Ïãú Îπà Î¨∏ÏûêÏó¥ Ï≤òÎ¶¨)
            EXISTING=$(gh api "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/contents/.github/copilot-instructions.md" --jq .content 2>/dev/null | base64 -d 2>/dev/null)
            
            # 2. ÎÇ¥Ïö© Î≥ëÌï© Î°úÏßÅ
            if [ -z "$EXISTING" ]; then
              echo "   -> Status: New File."
              FINAL_CONTENT="$CONTENT"
              MODE="Create"
            elif echo "$EXISTING" | grep -q "KARPATHY_CORE_GLOBAL"; then
              echo "   -> Status: Already Updated. Skipping."
              continue
            else
              echo "   -> Status: Merging."
              FINAL_CONTENT="$CONTENT"$'\n\n'"$EXISTING"
              MODE="Update"
            fi

            # 3. GitHub APIÎ°ú Ïª§Î∞ã (Ïò§Î•ò Î∞úÏÉù Ïãú Î°úÍ∑∏ Ï∂úÎ†•ÌïòÍ≥† Í≥ÑÏÜç ÏßÑÌñâ)
            # --silent ÏòµÏÖòÏùÑ Ï†úÍ±∞ÌïòÏó¨ Ïò§Î•ò ÏõêÏù∏ ÌôïÏù∏
            gh api --method PUT "/repos/${GITHUB_REPOSITORY_OWNER}/$repo/contents/.github/copilot-instructions.md" \
              -f message="${{ inputs.commit_message }}" \
              -f content="$(echo "$FINAL_CONTENT" | base64 -w 0)" \
              -f branch="main" 2>&1
              
            EXIT_CODE=$?
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "   ‚úÖ Success: $repo updated."
            else
              echo "   ‚ö†Ô∏è Failed: Could not update $repo (Exit Code: $EXIT_CODE)"
              echo "      (Check: Branch protection? Archived? Empty repo?)"
            fi
          done
